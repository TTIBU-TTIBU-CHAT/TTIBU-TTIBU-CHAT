name: Build and Push to ECR Public

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Which service to build and push?'
        required: true
        type: choice
        options:
          - all
          - frontend
          - core-api
          - summary-api
        default: 'all'

env:
  AWS_REGION: us-east-1  # ECR Publicì€ us-east-1ë§Œ ì§€ì›
  ECR_REGISTRY: public.ecr.aws/${{ secrets.ECR_PUBLIC_ALIAS }}

jobs:
  build-frontend:
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.service == 'all' ||
      github.event.inputs.service == 'frontend'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR Public
        run: |
          aws ecr-public get-login-password --region us-east-1 | \
            docker login --username AWS --password-stdin public.ecr.aws

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Frontend Docker image
        run: |
          echo "ðŸ”¨ Building Frontend..."
          docker build -t frontend:latest ./frontend
          echo "âœ… Frontend build complete"

      - name: Tag Frontend image
        run: |
          docker tag frontend:latest ${{ env.ECR_REGISTRY }}/ttibu/frontend:latest
          docker tag frontend:latest ${{ env.ECR_REGISTRY }}/ttibu/frontend:${{ github.sha }}
          echo "ðŸ“¦ Tagged: latest, ${{ github.sha }}"

      - name: Push Frontend to ECR Public
        run: |
          echo "ðŸš€ Pushing Frontend to ECR Public..."
          docker push ${{ env.ECR_REGISTRY }}/ttibu/frontend:latest
          docker push ${{ env.ECR_REGISTRY }}/ttibu/frontend:${{ github.sha }}
          echo "âœ… Frontend pushed successfully!"

      - name: Frontend Summary
        run: |
          echo "## ðŸŽ¨ Frontend Deployment" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** ${{ env.ECR_REGISTRY }}/ttibu/frontend" >> $GITHUB_STEP_SUMMARY
          echo "- **Tags:** latest, ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          docker images frontend:latest --format "- **Size:** {{.Size}}" >> $GITHUB_STEP_SUMMARY

  build-core-api:
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.service == 'all' ||
      github.event.inputs.service == 'core-api'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR Public
        run: |
          aws ecr-public get-login-password --region us-east-1 | \
            docker login --username AWS --password-stdin public.ecr.aws

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Core API Docker image
        run: |
          echo "ðŸ”¨ Building Core API..."
          docker build -t core-api:latest ./core-api
          echo "âœ… Core API build complete"

      - name: Tag Core API image
        run: |
          docker tag core-api:latest ${{ env.ECR_REGISTRY }}/ttibu/core-api:latest
          docker tag core-api:latest ${{ env.ECR_REGISTRY }}/ttibu/core-api:${{ github.sha }}
          echo "ðŸ“¦ Tagged: latest, ${{ github.sha }}"

      - name: Push Core API to ECR Public
        run: |
          echo "ðŸš€ Pushing Core API to ECR Public..."
          docker push ${{ env.ECR_REGISTRY }}/ttibu/core-api:latest
          docker push ${{ env.ECR_REGISTRY }}/ttibu/core-api:${{ github.sha }}
          echo "âœ… Core API pushed successfully!"

      - name: Core API Summary
        run: |
          echo "## âš™ï¸ Core API Deployment" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** ${{ env.ECR_REGISTRY }}/ttibu/core-api" >> $GITHUB_STEP_SUMMARY
          echo "- **Tags:** latest, ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          docker images core-api:latest --format "- **Size:** {{.Size}}" >> $GITHUB_STEP_SUMMARY

  build-summary-api:
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.service == 'all' ||
      github.event.inputs.service == 'summary-api'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR Public
        run: |
          aws ecr-public get-login-password --region us-east-1 | \
            docker login --username AWS --password-stdin public.ecr.aws

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Summary API Docker image
        run: |
          echo "ðŸ”¨ Building Summary API (This may take 20-30 minutes)..."
          docker build -t summary-api:latest ./summary-api
          echo "âœ… Summary API build complete"

      - name: Tag Summary API image
        run: |
          docker tag summary-api:latest ${{ env.ECR_REGISTRY }}/ttibu/summary-api:latest
          docker tag summary-api:latest ${{ env.ECR_REGISTRY }}/ttibu/summary-api:${{ github.sha }}
          echo "ðŸ“¦ Tagged: latest, ${{ github.sha }}"

      - name: Push Summary API to ECR Public
        run: |
          echo "ðŸš€ Pushing Summary API to ECR Public..."
          docker push ${{ env.ECR_REGISTRY }}/ttibu/summary-api:latest
          docker push ${{ env.ECR_REGISTRY }}/ttibu/summary-api:${{ github.sha }}
          echo "âœ… Summary API pushed successfully!"

      - name: Summary API Summary
        run: |
          echo "## ðŸ¤– Summary API Deployment" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** ${{ env.ECR_REGISTRY }}/ttibu/summary-api" >> $GITHUB_STEP_SUMMARY
          echo "- **Tags:** latest, ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          docker images summary-api:latest --format "- **Size:** {{.Size}}" >> $GITHUB_STEP_SUMMARY

  deployment-summary:
    needs: [build-frontend, build-core-api, build-summary-api]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Overall Deployment Summary
        run: |
          echo "# ðŸŽ‰ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Service:** ${{ github.event.inputs.service }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“¦ ECR Public Images" >> $GITHUB_STEP_SUMMARY
          echo "All images are now available at:" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: \`${{ env.ECR_REGISTRY }}/ttibu/frontend:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- Core API: \`${{ env.ECR_REGISTRY }}/ttibu/core-api:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- Summary API: \`${{ env.ECR_REGISTRY }}/ttibu/summary-api:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸš€ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Update ECS Task Definitions with new image URIs" >> $GITHUB_STEP_SUMMARY
          echo "2. Deploy to ECS services" >> $GITHUB_STEP_SUMMARY
          echo "3. Monitor CloudWatch logs for any issues" >> $GITHUB_STEP_SUMMARY
